openapi: 3.0.3
security:
  - ApiKeyAuth: []
components:
  schemas:
    SymbolId:
      type: string
      enum:
        - COINBASE_SPOT_BTC_USD
        - COINBASE_SPOT_ETH_USD
        - COINBASE_SPOT_SOL_USD
        - COINBASE_SPOT_AERO_USD
        - COINBASE_SPOT_RECALL_USD
      example: COINBASE_SPOT_BTC_USD
      examples:
        - COINBASE_SPOT_BTC_USD
        - COINBASE_SPOT_ETH_USD
        - COINBASE_SPOT_SOL_USD
        - COINBASE_SPOT_AERO_USD
        - COINBASE_SPOT_RECALL_USD
    Timeframe:
      type: string
      enum:
        - 1m
        - 5m
        - 15m
        - 1h
        - 4h
        - 1d
      example: 1h
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Machine-readable error code
      required:
        - error
    Candle:
      type: object
      properties:
        timestamp:
          type: string
          description: ISO 8601 datetime
        open:
          type: number
          description: Opening price
        high:
          type: number
          description: Highest price
        low:
          type: number
          description: Lowest price
        close:
          type: number
          description: Closing price
        volume:
          type: number
          description: Trading volume
        trades_count:
          type: integer
          nullable: true
          description: Number of trades
      required:
        - timestamp
        - open
        - high
        - low
        - close
        - volume
    OHLCVResponse:
      type: object
      properties:
        symbol_id:
          type: string
          description: Trading pair symbol
        timeframe:
          type: string
          description: Candle interval
        candles:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                description: ISO 8601 datetime
              open:
                type: number
                description: Opening price
              high:
                type: number
                description: Highest price
              low:
                type: number
                description: Lowest price
              close:
                type: number
                description: Closing price
              volume:
                type: number
                description: Trading volume
              trades_count:
                type: integer
                nullable: true
                description: Number of trades
            required:
              - timestamp
              - open
              - high
              - low
              - close
              - volume
          description: OHLCV candles
      required:
        - symbol_id
        - timeframe
        - candles
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          description: Health status
      required:
        - status
    OrderbookResponse:
      type: object
      properties:
        symbol_id:
          type: string
          description: Trading pair symbol
        snapshots:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                description: ISO 8601 datetime
              mid_price:
                type: number
                description: (best_bid + best_ask) / 2
              spread:
                type: number
                description: best_ask - best_bid
              spread_bps:
                type: number
                description: Spread in basis points
              imbalance:
                type: number
                minimum: -1
                maximum: 1
                description: (bid_depth - ask_depth) / (bid_depth + ask_depth)
              bid_depth:
                type: number
                description: Total size on bid side
              ask_depth:
                type: number
                description: Total size on ask side
            required:
              - timestamp
              - mid_price
              - spread
              - spread_bps
              - imbalance
              - bid_depth
              - ask_depth
          description: Orderbook snapshots
      required:
        - symbol_id
        - snapshots
    IndicatorsResponse:
      type: object
      properties:
        symbol_id:
          type: string
          description: Trading pair symbol
        timeframe:
          type: string
          description: Candle interval
        candles:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                description: ISO 8601 datetime
              open:
                type: number
                description: Opening price
              high:
                type: number
                description: Highest price
              low:
                type: number
                description: Lowest price
              close:
                type: number
                description: Closing price
              volume:
                type: number
                description: Trading volume
              trades_count:
                type: integer
                nullable: true
                description: Number of trades
            required:
              - timestamp
              - open
              - high
              - low
              - close
              - volume
          description: OHLCV candles
        indicators:
          type: object
          properties:
            bbw:
              type: number
              nullable: true
              description: Bollinger Band Width (20-period, 2 std dev)
            realized_vol:
              type: number
              nullable: true
              description: Rolling standard deviation of log returns
            recent_returns:
              type: array
              items:
                type: number
              description: Last N log returns
            rsi:
              type: number
              nullable: true
              description: Relative Strength Index (14-period)
            atr:
              type: number
              nullable: true
              description: Average True Range (14-period)
            macd:
              type: object
              nullable: true
              properties:
                macd:
                  type: number
                  description: MACD line
                signal:
                  type: number
                  description: Signal line
                histogram:
                  type: number
                  description: MACD histogram (MACD - Signal)
              required:
                - macd
                - signal
                - histogram
              description: MACD indicator (12, 26, 9 periods)
            stoch_rsi:
              type: object
              nullable: true
              properties:
                stoch_rsi:
                  type: number
                  description: Stochastic RSI value (0-100)
                k:
                  type: number
                  description: "%K line (0-100)"
                d:
                  type: number
                  description: "%D line (0-100)"
              required:
                - stoch_rsi
                - k
                - d
              description: Stochastic RSI (14, 14, 3, 3 periods)
            adx:
              type: number
              nullable: true
              description: Average Directional Index (14-period, 0-100)
            cmf:
              type: number
              nullable: true
              description: Chaikin Money Flow (20-period, -1 to 1)
            supertrend:
              type: object
              nullable: true
              properties:
                value:
                  type: number
                  description: SuperTrend line value
                advice:
                  type: string
                  enum:
                    - long
                    - short
                  description: Trading signal based on price vs SuperTrend
              required:
                - value
                - advice
              description: SuperTrend indicator (10-period ATR, 3x multiplier)
            price:
              type: number
              description: Latest close price
          required:
            - bbw
            - realized_vol
            - recent_returns
            - rsi
            - atr
            - macd
            - stoch_rsi
            - adx
            - cmf
            - supertrend
            - price
          description: Computed indicators for latest candle
        vwap:
          type: object
          nullable: true
          properties:
            vwap:
              type: number
              description: Volume-weighted average price
            upper_band:
              type: number
              description: VWAP + 1 std dev
            lower_band:
              type: number
              description: VWAP - 1 std dev
            std_dev:
              type: number
              description: Standard deviation
          required:
            - vwap
            - upper_band
            - lower_band
            - std_dev
          description: VWAP with bands
        rolling_vwap:
          type: object
          nullable: true
          properties:
            vwap_per_bar:
              type: array
              items:
                type: number
              description: Cumulative VWAP at each candle
            close_above_vwap:
              type: array
              items:
                type: boolean
              description: Whether close was above VWAP at each bar
            acceptance_count:
              type: integer
              description: Count of bars where close > VWAP
            acceptance_ratio:
              type: number
              minimum: 0
              maximum: 1
              description: Ratio of bars above VWAP (0-1)
            price_to_vwap_bp:
              type: integer
              description: Current price distance from VWAP in basis points
          required:
            - vwap_per_bar
            - close_above_vwap
            - acceptance_count
            - acceptance_ratio
            - price_to_vwap_bp
          description: Per-bar VWAP evolution and acceptance analysis
      required:
        - symbol_id
        - timeframe
        - candles
        - indicators
        - vwap
        - rolling_vwap
    ReplayResponse:
      type: object
      properties:
        symbol_id:
          type: string
          description: Trading pair symbol
        from:
          type: string
          description: Start time (ISO 8601)
        to:
          type: string
          description: End time (ISO 8601)
        observations:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                description: ISO 8601 datetime
              ohlcv:
                type: object
                properties:
                  open:
                    type: number
                    description: Opening price
                  high:
                    type: number
                    description: Highest price
                  low:
                    type: number
                    description: Lowest price
                  close:
                    type: number
                    description: Closing price
                  volume:
                    type: number
                    description: Trading volume
                required:
                  - open
                  - high
                  - low
                  - close
                  - volume
                description: OHLCV candle data
              orderbook:
                type: object
                properties:
                  mid_price:
                    type: number
                    description: (best_bid + best_ask) / 2
                  spread:
                    type: number
                    description: best_ask - best_bid
                  spread_bps:
                    type: number
                    description: Spread in basis points
                  imbalance:
                    type: number
                    description: (bid_depth - ask_depth) / (bid_depth + ask_depth)
                  bid_depth:
                    type: number
                    description: Total size on bid side
                  ask_depth:
                    type: number
                    description: Total size on ask side
                required:
                  - mid_price
                  - spread
                  - spread_bps
                  - imbalance
                  - bid_depth
                  - ask_depth
                description: Orderbook metrics
            required:
              - timestamp
              - ohlcv
              - orderbook
          description: Observation packets for replay
      required:
        - symbol_id
        - from
        - to
        - observations
    ReplaysListResponse:
      type: object
      properties:
        symbols:
          type: array
          items:
            type: object
            properties:
              symbol_id:
                type: string
                description: Trading pair symbol
              timeframe:
                type: string
                description: Candle timeframe (e.g., 1m)
              earliest:
                type: string
                nullable: true
                description: Earliest available data (ISO 8601)
              latest:
                type: string
                nullable: true
                description: Latest available data (ISO 8601)
              candle_count:
                type: integer
                description: Total number of candles
              duration_minutes:
                type: integer
                description: Duration in minutes
            required:
              - symbol_id
              - timeframe
              - earliest
              - latest
              - candle_count
              - duration_minutes
          description: Available replay data per symbol
        generated_at:
          type: string
          description: When this data was generated (ISO 8601)
      required:
        - symbols
        - generated_at
    AnnotationsResponse:
      type: object
      properties:
        symbol_id:
          type: string
          description: Trading pair symbol
        annotations:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
                description: Unique annotation identifier
              time_start:
                type: string
                description: Start time (ISO 8601)
              time_end:
                type: string
                nullable: true
                description: End time (ISO 8601), null for point-in-time events
              type:
                type: string
                description: Annotation type (e.g., dump_event, regime, vol_spike)
              schema_version:
                type: string
                description: Payload schema version
              payload:
                type: object
                additionalProperties:
                  nullable: true
                description: Type-specific annotation data
              source:
                type: string
                description: Annotator that created this annotation
              created_at:
                type: string
                description: Creation timestamp (ISO 8601)
            required:
              - id
              - time_start
              - time_end
              - type
              - schema_version
              - payload
              - source
          description: List of annotations
      required:
        - symbol_id
        - annotations
    AnnotatorsListResponse:
      type: object
      properties:
        annotators:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
                description: Unique annotator identifier
              version:
                type: string
                description: Annotator version
              annotation_type:
                type: string
                description: Type of annotations produced
              source:
                type: string
                description: Source identifier for created annotations
              window_size:
                type: string
                description: Processing window size (e.g., 1m, 15m, 1h)
              status:
                type: string
                enum:
                  - backfilling
                  - active
                  - deprecated
                description: Current operational status
              description:
                type: string
                description: Human-readable description
            required:
              - name
              - version
              - annotation_type
              - source
              - window_size
              - status
              - description
          description: List of registered annotators
      required:
        - annotators
    AnnotatorDetailResponse:
      type: object
      properties:
        annotator:
          type: object
          properties:
            name:
              type: string
              description: Unique annotator identifier
            version:
              type: string
              description: Annotator version
            annotation_type:
              type: string
              description: Type of annotations produced
            source:
              type: string
              description: Source identifier for created annotations
            window_size:
              type: string
              description: Processing window size
            start_time:
              type: string
              description: Start time for processing
            status:
              type: string
              description: Current operational status
            description:
              type: string
              description: Human-readable description
            config:
              type: object
              additionalProperties:
                nullable: true
              description: Annotator configuration
            registered_at:
              type: string
              description: Registration timestamp
          required:
            - name
            - version
            - annotation_type
            - source
            - window_size
            - status
            - description
            - config
          description: Annotator details
        progress:
          type: object
          properties:
            windows_processed:
              type: integer
              description: Total windows processed
            annotations_created:
              type: integer
              description: Total annotations created
            last_processed_at:
              type: string
              nullable: true
              description: Last processing timestamp (ISO 8601)
          required:
            - windows_processed
            - annotations_created
            - last_processed_at
          description: Processing progress
      required:
        - annotator
        - progress
    AnnotatorRunResponse:
      type: object
      properties:
        annotator:
          type: string
          description: Annotator name
        symbol_id:
          type: string
          description: Symbol processed
        from:
          type: string
          description: Start time (ISO 8601)
        to:
          type: string
          description: End time (ISO 8601)
        windows_processed:
          type: integer
          description: Number of windows processed
        annotations_created:
          type: integer
          description: Number of annotations created
      required:
        - annotator
        - symbol_id
        - from
        - to
        - windows_processed
        - annotations_created
    IngestionResult:
      type: object
      properties:
        batchId:
          type: string
          description: Unique batch identifier
        ohlcvCount:
          type: integer
          description: Number of OHLCV candles ingested
        orderbookCount:
          type: integer
          description: Number of orderbook snapshots ingested
        symbols:
          type: array
          items:
            type: string
          description: Symbols processed in this ingestion run
      required:
        - batchId
        - ohlcvCount
        - orderbookCount
        - symbols
  parameters: {}
info:
  title: Replay Lab API
  version: 2.0.0
  description: |
    **Replayable market data lab for AI agent evaluation.**

    Replay Lab is a specialized microservice for **generating labeled training data** for ML models that predict market events. It employs a **hybrid storage strategy** - eager storage for raw market data, lazy computation for derived indicators and annotations.

    ## Quick Start

    ```bash
    # Get recent BTC candles
    curl "/api/ohlcv/COINBASE_SPOT_BTC_USD?limit=100"

    # Get candles with technical indicators
    curl "/api/indicators/COINBASE_SPOT_BTC_USD?limit=50"

    # Get ground truth annotations for agent scoring
    curl "/api/annotations/COINBASE_SPOT_BTC_USD?type=dump_event"

    # Replay historical data for backtesting
    curl "/api/replay/COINBASE_SPOT_BTC_USD?from=2025-12-15T00:00:00Z&to=2025-12-15T12:00:00Z"

    # Generate a chart image with SMA indicator
    curl "/api/charts/COINBASE_SPOT_BTC_USD/image?layers=candles,sma:20" > chart.png
    ```

    ## Architecture: Hybrid Computation

    ### Eager Storage (OHLCV Candles)
    Raw candlestick data is ingested immediately and persisted forever:
    - **Source of truth** for all downstream computations
    - **Immutable** - historical candles never change
    - **Gap healing** - automatic detection and backfill of missing data

    ### Lazy Computation (Indicators & Annotations)
    Derived data is computed on-demand:
    - **Indicators** (RSI, MACD, ATR, etc.) - computed fresh on every request, never stored
    - **Annotations** (dump events, regime changes) - computed on first request, cached incrementally

    **Why lazy?**
    - Storage efficiency (10-100x smaller database)
    - Algorithm flexibility (change detection logic without migrations)
    - Fresh computations always use latest code

    ## Data Sources
    - **OHLCV**: Real 1-minute candles from CoinAPI (executed trades)
    - **Orderbook**: 20-level depth snapshots with mid_price, spread, imbalance

    ## Supported Symbols
    Currently supported (Coinbase USD spot pairs):
    - `COINBASE_SPOT_BTC_USD`
    - `COINBASE_SPOT_ETH_USD`
    - `COINBASE_SPOT_SOL_USD`
    - `COINBASE_SPOT_AERO_USD`
    - `COINBASE_SPOT_RECALL_USD`
servers:
  - url: /
    description: Replay Lab API
tags:
  - name: Charts
    description: >
      Static chart image generation with edge caching.


      Generate beautiful financial charts as PNG/JPEG images on-demand.

      Images are cached at Vercel's edge CDN for fast global delivery.


      ## Features


      - **Layered visualizations**: Combine candles, moving averages, Bollinger
      Bands, oscillators

      - **Smart caching**: Historical charts cached for 1 year, current charts
      TTL by timeframe

      - **Multiple styles**: Candlestick, OHLC, line, area, Heikin-Ashi

      - **Multi-panel**: Price + Volume + Oscillator panels automatically
      composed


      ## Layer Syntax


      Layers are comma-separated: `layers=candles,sma:20,ema:50,bb:20:2`


      **Chartable layers** (return time-series data):


      | Layer | Params | Panel | Description |

      |-------|--------|-------|-------------|

      | `candles` | - | price | OHLCV candlesticks |

      | `sma` | period | price | Simple Moving Average |

      | `ema` | period | price | Exponential Moving Average |

      | `bb` | period,stdDev | price | Bollinger Bands |

      | `vwap` | - | price | Volume Weighted Average Price |

      | `volume` | - | volume | Volume histogram |


      **Not yet chartable** (use `/indicators` endpoint instead):

      RSI, MACD, StochRSI, ADX, ATR, CMF, CHOP, SuperTrend, VolumeRatio
  - name: Market Data
    description: >
      OHLCV candles and technical indicators.


      ## Technical Indicators


      The `/indicators` endpoint computes 15+ technical indicators on-the-fly:


      **Momentum**: RSI (14-period, Wilder's smoothing), Stochastic RSI
      (14,14,5,3)


      **Trend**: MACD (12,26,9), ADX (14-period), SuperTrend (10,3)


      **Volatility**: ATR (14-period, Wilder's smoothing), Bollinger Band Width
      (20), Realized Volatility


      **Volume**: CMF (20-period), VWAP with bands


      ### Smoothing Methods


      Different indicators use different smoothing:

      - **SMA**: Arithmetic mean (Bollinger Bands)

      - **EMA**: Exponential weighted (MACD)

      - **Wilder's**: Modified EMA with 1/period factor (RSI, ATR) - matches
      TradingView/TAAPI


      ### Adding New Indicators


      1. Create indicator file in `/lib/indicators/`

      2. Validate input length, return `null` for insufficient data

      3. Export from `index.ts` and add to API route

      4. Write tests validating against TAAPI reference


      **Critical**: Candles must be ordered oldest-first (ascending) for correct
      calculations.
  - name: Replay
    description: >
      Historical data replay for backtesting and agent evaluation.


      The replay endpoint combines OHLCV and orderbook data into unified
      observation packets,

      time-ordered ascending for sequential replay.
  - name: Annotators
    description: >
      Annotation generation system for ground truth labels.


      ## What Are Annotations?


      Annotations are **labeled time ranges** representing ground truth events:

      - **Agent evaluation** - Measure how well trading agents detect dumps,
      pumps, regime changes

      - **Backtesting** - Test strategies against historical events

      - **Data labeling** - Create supervised learning datasets


      ## Building Custom Annotators


      An annotator is a registered function that processes candles and emits
      annotations.


      ### Annotator Definition


      ```typescript

      defineAnnotator({
        name: 'dump-simple-1m-3pct',
        version: 'v1',
        annotationType: 'dump_event',
        source: 'ohlcv_candles',
        windowSize: '1h',
        config: { threshold: -0.03 },

        transform: async (context) => {
          const dumps = []
          for (const candle of context.candles) {
            const returnPct = (candle.close - candle.open) / candle.open
            if (returnPct <= context.config.threshold) {
              dumps.push({
                timeStart: candle.timestamp,
                payload: { returnPct, method: 'simple-threshold' }
              })
            }
          }
          return dumps
        }
      })

      ```


      ### Annotator Types


      **Simple Threshold**: Flag candles crossing a return threshold

      - `dump-simple-{timeframe}-{pct}` - e.g., dump-simple-1m-3pct


      **Volatility-Adjusted**: Normalize returns by rolling volatility (z-score)

      - `dump-vol-adjusted-{timeframe}-z{threshold}` - e.g.,
      dump-vol-adjusted-1m-z2


      **Drawdown**: Track peak-to-trough with recovery detection

      - `dump-drawdown-{pct}` - e.g., dump-drawdown-3pct


      ### Version Bumping


      Bump `version` when algorithm logic changes - triggers fresh backfill
      while preserving old annotations.
  - name: Annotations
    description: >
      Query ground truth annotations for agent self-scoring.


      Annotations are computed lazily on first request, then cached
      incrementally.

      Subsequent queries for the same time range are instant.


      ### Cache Warming


      Pre-compute annotations for your training date ranges:

      ```bash

      curl
      "/api/annotations/COINBASE_SPOT_BTC_USD?from=2025-12-01&to=2025-12-08"

      # Subsequent queries will be instant (cache hits)

      ```
  - name: System
    description: |
      System endpoints for health checks and data ingestion.

      ## Data Ingestion

      The cron endpoint runs every minute, performing:
      1. Fetch latest OHLCV candles for all symbols
      2. Fetch order book snapshots
      3. Detect gaps in last 60 minutes
      4. Heal gaps by fetching missing candles
      5. Compute orderbook metrics (mid-price, spread, imbalance)

      ### Adding New Symbols

      1. Verify CoinAPI supports the symbol
      2. Add to `SYMBOLS` array in `/lib/coinapi.ts`
      3. Deploy - ingestion starts automatically

      ### Gap Healing

      Automatic detection and backfill of missing candles:
      - Scans last 60 minutes for gaps > 1 minute
      - Fetches missing data via time-range queries
      - Maximum 10 gaps healed per symbol per run (rate limit protection)
paths:
  /api/health:
    get:
      summary: Health check
      description: Returns service health status.
      tags:
        - System
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    description: Health status
                required:
                  - status
  /api/ohlcv/{symbolId}:
    get:
      summary: Get OHLCV candles
      description: Returns real OHLCV candles from executed trades. Supports timeframe
        aggregation (1m, 5m, 15m, 1h, 4h, 1d).
      tags:
        - Market Data
      parameters:
        - schema:
            type: string
            enum:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
            example: COINBASE_SPOT_BTC_USD
            examples:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
          required: true
          name: symbolId
          in: path
        - schema:
            type: string
            enum:
              - 1m
              - 5m
              - 15m
              - 1h
              - 4h
              - 1d
            default: 1m
            example: 1m
            description: Candle interval
          required: false
          description: Candle interval
          name: timeframe
          in: query
        - schema:
            type: string
            description: "Start time (ISO 8601). Default: 24h ago"
            example: 2025-12-16T17:00:00Z
          required: false
          description: "Start time (ISO 8601). Default: 24h ago"
          name: from
          in: query
        - schema:
            type: string
            description: "End time (ISO 8601). Default: now"
            example: 2025-12-16T18:00:00Z
          required: false
          description: "End time (ISO 8601). Default: now"
          name: to
          in: query
        - schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
            description: Max records (1-1000)
            example: 100
          required: false
          description: Max records (1-1000)
          name: limit
          in: query
      responses:
        "200":
          description: OHLCV candles
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbol_id:
                    type: string
                    description: Trading pair symbol
                  timeframe:
                    type: string
                    description: Candle interval
                  candles:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                          description: ISO 8601 datetime
                        open:
                          type: number
                          description: Opening price
                        high:
                          type: number
                          description: Highest price
                        low:
                          type: number
                          description: Lowest price
                        close:
                          type: number
                          description: Closing price
                        volume:
                          type: number
                          description: Trading volume
                        trades_count:
                          type: integer
                          nullable: true
                          description: Number of trades
                      required:
                        - timestamp
                        - open
                        - high
                        - low
                        - close
                        - volume
                    description: OHLCV candles
                required:
                  - symbol_id
                  - timeframe
                  - candles
        "400":
          description: Invalid parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
        "404":
          description: No data found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
  /api/charts/{symbolId}/image:
    get:
      summary: Generate chart image
      description: >
        Renders a static chart image with configurable layers and caching.


        **Caching behavior:**

        - Historical charts (time range before current bar): Cached for 1 year
        (immutable)

        - Current charts: Cached based on timeframe (1m=30s, 1h=30min, 1d=12h)


        **Canonical redirect:**

        When `from`/`to` are omitted, the server returns a 302 redirect to a
        canonical URL

        with explicit timestamps. This ensures stable cache keys.
      tags:
        - Charts
      parameters:
        - schema:
            type: string
            enum:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
            example: COINBASE_SPOT_BTC_USD
            examples:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
            description: Trading pair symbol
          required: true
          description: Trading pair symbol
          name: symbolId
          in: path
        - schema:
            type: string
            enum:
              - 1m
              - 5m
              - 15m
              - 1h
              - 4h
              - 1d
            default: 1h
            example: 1h
            description: Candle interval
          required: false
          description: Candle interval
          name: timeframe
          in: query
        - schema:
            type: string
            format: date-time
            description: Start time (ISO 8601). If omitted, computed from lookback.
            example: 2025-12-18T00:00:00Z
          required: false
          description: Start time (ISO 8601). If omitted, computed from lookback.
          name: from
          in: query
        - schema:
            type: string
            format: date-time
            description: End time (ISO 8601). If omitted, uses current time bucket.
            example: 2025-12-18T21:00:00Z
          required: false
          description: End time (ISO 8601). If omitted, uses current time bucket.
          name: to
          in: query
        - schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 60
            description: Number of bars to include (used when from/to omitted)
          required: false
          description: Number of bars to include (used when from/to omitted)
          name: lookback
          in: query
        - schema:
            type: string
            description: Chart type (deprecated, use style instead)
          required: false
          description: Chart type (deprecated, use style instead)
          name: chartType
          in: query
        - schema:
            type: string
            enum:
              - candles
              - ohlc
              - line
              - area
              - heikin_ashi
            default: candles
            example: candles
            description: Price chart rendering style
          required: false
          description: Price chart rendering style
          name: style
          in: query
        - schema:
            type: string
            default: candles,sma
            description: "Comma-separated layer specs. Format: `type[:param1[:param2]]`.
              Supported: candles, sma, ema, bb, vwap, volume"
            example: candles,sma
          required: false
          description: "Comma-separated layer specs. Format: `type[:param1[:param2]]`.
            Supported: candles, sma, ema, bb, vwap, volume"
          name: layers
          in: query
        - schema:
            type: integer
            minimum: 100
            maximum: 2000
            default: 1200
            description: Image width in pixels
            example: 1200
          required: false
          description: Image width in pixels
          name: width
          in: query
        - schema:
            type: integer
            minimum: 100
            maximum: 1200
            default: 628
            description: Image height in pixels
            example: 628
          required: false
          description: Image height in pixels
          name: height
          in: query
        - schema:
            type: string
            enum:
              - light
              - dark
            default: dark
            example: dark
            description: Color theme
          required: false
          description: Color theme
          name: theme
          in: query
        - schema:
            type: string
            enum:
              - png
              - jpeg
            default: png
            example: png
            description: Output image format
          required: false
          description: Output image format
          name: format
          in: query
        - schema:
            type: string
            enum:
              - auto
              - hidden
            default: auto
            example: auto
            description: Legend visibility
          required: false
          description: Legend visibility
          name: legend
          in: query
        - schema:
            type: string
            default: "1"
            description: Indicator version (for cache busting when algorithms change)
            example: "1"
          required: false
          description: Indicator version (for cache busting when algorithms change)
          name: iv
          in: query
        - schema:
            type: string
            description: Comma-separated annotation sources to overlay on chart
          required: false
          description: Comma-separated annotation sources to overlay on chart
          name: annotations
          in: query
      responses:
        "200":
          description: Chart image
          content:
            image/png:
              schema:
                type: string
        "302":
          description: Redirect to canonical URL (when from/to omitted)
        "400":
          description: Invalid parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
        "404":
          description: No data found for time range
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
  /api/orderbook/{symbolId}:
    get:
      summary: Get order book snapshots
      description: >
        Returns historical order book snapshots with derived microstructure
        metrics:

        - `mid_price`: (best_bid + best_ask) / 2

        - `spread`: best_ask - best_bid

        - `spread_bps`: spread in basis points

        - `imbalance`: (bid_depth - ask_depth) / (bid_depth + ask_depth)

        - `bid_depth`, `ask_depth`: Total size on each side
      tags:
        - Market Data
      parameters:
        - schema:
            type: string
            enum:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
            example: COINBASE_SPOT_BTC_USD
            examples:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
          required: true
          name: symbolId
          in: path
        - schema:
            type: string
            description: "Start time (ISO 8601). Default: 1h ago"
            example: 2025-12-16T17:00:00Z
          required: false
          description: "Start time (ISO 8601). Default: 1h ago"
          name: from
          in: query
        - schema:
            type: string
            description: "End time (ISO 8601). Default: now"
            example: 2025-12-16T18:00:00Z
          required: false
          description: "End time (ISO 8601). Default: now"
          name: to
          in: query
        - schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
            description: Max snapshots (1-1000)
            example: 100
          required: false
          description: Max snapshots (1-1000)
          name: limit
          in: query
      responses:
        "200":
          description: Order book snapshots
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbol_id:
                    type: string
                    description: Trading pair symbol
                  snapshots:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                          description: ISO 8601 datetime
                        mid_price:
                          type: number
                          description: (best_bid + best_ask) / 2
                        spread:
                          type: number
                          description: best_ask - best_bid
                        spread_bps:
                          type: number
                          description: Spread in basis points
                        imbalance:
                          type: number
                          minimum: -1
                          maximum: 1
                          description: (bid_depth - ask_depth) / (bid_depth + ask_depth)
                        bid_depth:
                          type: number
                          description: Total size on bid side
                        ask_depth:
                          type: number
                          description: Total size on ask side
                      required:
                        - timestamp
                        - mid_price
                        - spread
                        - spread_bps
                        - imbalance
                        - bid_depth
                        - ask_depth
                    description: Orderbook snapshots
                required:
                  - symbol_id
                  - snapshots
        "400":
          description: Invalid parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
        "404":
          description: No snapshots found for time range
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
  /api/indicators/{symbolId}:
    get:
      summary: Get computed indicators
      description: >
        Returns OHLCV candles with computed technical indicators:

        - **BBW**: Bollinger Band Width (20-period, 2 std dev)

        - **Realized Volatility**: Rolling standard deviation of log returns

        - **VWAP**: Volume-weighted average price with bands

        - **Recent Returns**: Last N log returns

        - **RSI**: Relative Strength Index (14-period, Wilder's smoothing)

        - **ATR**: Average True Range (14-period, Wilder's smoothing)

        - **MACD**: Moving Average Convergence Divergence (12, 26, 9)

        - **Stochastic RSI**: Stochastic RSI with %K and %D lines (14, 14, 5, 3)

        - **ADX**: Average Directional Index (14-period)

        - **CMF**: Chaikin Money Flow (20-period)

        - **SuperTrend**: Trend-following indicator with long/short signals (10,
        3)


        **Ordering**: Candles are returned in ascending order (oldest first).

        Indicators are computed on the full candle window, using Wilder's
        smoothing

        for RSI and ATR (matching TradingView/TAAPI methodology).
      tags:
        - Market Data
      parameters:
        - schema:
            type: string
            enum:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
            example: COINBASE_SPOT_BTC_USD
            examples:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
          required: true
          name: symbolId
          in: path
        - schema:
            type: string
            enum:
              - 1m
              - 5m
              - 15m
              - 1h
              - 4h
              - 1d
            default: 1m
            example: 1m
            description: Candle interval
          required: false
          description: Candle interval
          name: timeframe
          in: query
        - schema:
            type: string
            description: "Start time (ISO 8601). Default: 24h ago"
            example: 2025-12-16T17:00:00Z
          required: false
          description: "Start time (ISO 8601). Default: 24h ago"
          name: from
          in: query
        - schema:
            type: string
            description: "End time (ISO 8601). Default: now"
            example: 2025-12-16T18:00:00Z
          required: false
          description: "End time (ISO 8601). Default: now"
          name: to
          in: query
        - schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 20
            description: Max candles (1-1000)
            example: 20
          required: false
          description: Max candles (1-1000)
          name: limit
          in: query
      responses:
        "200":
          description: Candles with computed indicators
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbol_id:
                    type: string
                    description: Trading pair symbol
                  timeframe:
                    type: string
                    description: Candle interval
                  candles:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                          description: ISO 8601 datetime
                        open:
                          type: number
                          description: Opening price
                        high:
                          type: number
                          description: Highest price
                        low:
                          type: number
                          description: Lowest price
                        close:
                          type: number
                          description: Closing price
                        volume:
                          type: number
                          description: Trading volume
                        trades_count:
                          type: integer
                          nullable: true
                          description: Number of trades
                      required:
                        - timestamp
                        - open
                        - high
                        - low
                        - close
                        - volume
                    description: OHLCV candles
                  indicators:
                    type: object
                    properties:
                      bbw:
                        type: number
                        nullable: true
                        description: Bollinger Band Width (20-period, 2 std dev)
                      realized_vol:
                        type: number
                        nullable: true
                        description: Rolling standard deviation of log returns
                      recent_returns:
                        type: array
                        items:
                          type: number
                        description: Last N log returns
                      rsi:
                        type: number
                        nullable: true
                        description: Relative Strength Index (14-period)
                      atr:
                        type: number
                        nullable: true
                        description: Average True Range (14-period)
                      macd:
                        type: object
                        nullable: true
                        properties:
                          macd:
                            type: number
                            description: MACD line
                          signal:
                            type: number
                            description: Signal line
                          histogram:
                            type: number
                            description: MACD histogram (MACD - Signal)
                        required:
                          - macd
                          - signal
                          - histogram
                        description: MACD indicator (12, 26, 9 periods)
                      stoch_rsi:
                        type: object
                        nullable: true
                        properties:
                          stoch_rsi:
                            type: number
                            description: Stochastic RSI value (0-100)
                          k:
                            type: number
                            description: "%K line (0-100)"
                          d:
                            type: number
                            description: "%D line (0-100)"
                        required:
                          - stoch_rsi
                          - k
                          - d
                        description: Stochastic RSI (14, 14, 3, 3 periods)
                      adx:
                        type: number
                        nullable: true
                        description: Average Directional Index (14-period, 0-100)
                      cmf:
                        type: number
                        nullable: true
                        description: Chaikin Money Flow (20-period, -1 to 1)
                      supertrend:
                        type: object
                        nullable: true
                        properties:
                          value:
                            type: number
                            description: SuperTrend line value
                          advice:
                            type: string
                            enum:
                              - long
                              - short
                            description: Trading signal based on price vs SuperTrend
                        required:
                          - value
                          - advice
                        description: SuperTrend indicator (10-period ATR, 3x multiplier)
                      price:
                        type: number
                        description: Latest close price
                    required:
                      - bbw
                      - realized_vol
                      - recent_returns
                      - rsi
                      - atr
                      - macd
                      - stoch_rsi
                      - adx
                      - cmf
                      - supertrend
                      - price
                    description: Computed indicators for latest candle
                  vwap:
                    type: object
                    nullable: true
                    properties:
                      vwap:
                        type: number
                        description: Volume-weighted average price
                      upper_band:
                        type: number
                        description: VWAP + 1 std dev
                      lower_band:
                        type: number
                        description: VWAP - 1 std dev
                      std_dev:
                        type: number
                        description: Standard deviation
                    required:
                      - vwap
                      - upper_band
                      - lower_band
                      - std_dev
                    description: VWAP with bands
                  rolling_vwap:
                    type: object
                    nullable: true
                    properties:
                      vwap_per_bar:
                        type: array
                        items:
                          type: number
                        description: Cumulative VWAP at each candle
                      close_above_vwap:
                        type: array
                        items:
                          type: boolean
                        description: Whether close was above VWAP at each bar
                      acceptance_count:
                        type: integer
                        description: Count of bars where close > VWAP
                      acceptance_ratio:
                        type: number
                        minimum: 0
                        maximum: 1
                        description: Ratio of bars above VWAP (0-1)
                      price_to_vwap_bp:
                        type: integer
                        description: Current price distance from VWAP in basis points
                    required:
                      - vwap_per_bar
                      - close_above_vwap
                      - acceptance_count
                      - acceptance_ratio
                      - price_to_vwap_bp
                    description: Per-bar VWAP evolution and acceptance analysis
                required:
                  - symbol_id
                  - timeframe
                  - candles
                  - indicators
                  - vwap
                  - rolling_vwap
        "400":
          description: Invalid parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
        "404":
          description: No candles found for time range
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
  /api/replay/{symbolId}:
    get:
      summary: Replay historical observations
      description: |
        Returns unified observation packets combining OHLCV and orderbook data.

        Each packet contains everything an agent needs for decision-making:
        - OHLCV data (open, high, low, close, volume)
        - Orderbook metrics (mid_price, spread, imbalance, depth)

        Observations are time-ordered ascending for replay.
      tags:
        - Replay
      parameters:
        - schema:
            type: string
            enum:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
            example: COINBASE_SPOT_BTC_USD
            examples:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
          required: true
          name: symbolId
          in: path
        - schema:
            type: string
            description: Start time (ISO 8601). Required.
            example: 2025-12-16T17:00:00Z
          required: true
          description: Start time (ISO 8601). Required.
          name: from
          in: query
        - schema:
            type: string
            description: End time (ISO 8601). Required.
            example: 2025-12-16T18:00:00Z
          required: true
          description: End time (ISO 8601). Required.
          name: to
          in: query
        - schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
            description: Max observations (1-1000)
            example: 100
          required: false
          description: Max observations (1-1000)
          name: limit
          in: query
      responses:
        "200":
          description: Observation packets for replay
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbol_id:
                    type: string
                    description: Trading pair symbol
                  from:
                    type: string
                    description: Start time (ISO 8601)
                  to:
                    type: string
                    description: End time (ISO 8601)
                  observations:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                          description: ISO 8601 datetime
                        ohlcv:
                          type: object
                          properties:
                            open:
                              type: number
                              description: Opening price
                            high:
                              type: number
                              description: Highest price
                            low:
                              type: number
                              description: Lowest price
                            close:
                              type: number
                              description: Closing price
                            volume:
                              type: number
                              description: Trading volume
                          required:
                            - open
                            - high
                            - low
                            - close
                            - volume
                          description: OHLCV candle data
                        orderbook:
                          type: object
                          properties:
                            mid_price:
                              type: number
                              description: (best_bid + best_ask) / 2
                            spread:
                              type: number
                              description: best_ask - best_bid
                            spread_bps:
                              type: number
                              description: Spread in basis points
                            imbalance:
                              type: number
                              description: (bid_depth - ask_depth) / (bid_depth + ask_depth)
                            bid_depth:
                              type: number
                              description: Total size on bid side
                            ask_depth:
                              type: number
                              description: Total size on ask side
                          required:
                            - mid_price
                            - spread
                            - spread_bps
                            - imbalance
                            - bid_depth
                            - ask_depth
                          description: Orderbook metrics
                      required:
                        - timestamp
                        - ohlcv
                        - orderbook
                    description: Observation packets for replay
                required:
                  - symbol_id
                  - from
                  - to
                  - observations
        "400":
          description: Invalid or missing parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
        "404":
          description: No observations found for time range
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
  /api/replays:
    get:
      summary: List available replay data
      description: |
        Returns what time ranges have complete OHLCV data available per symbol.
        Use this to discover what data exists before requesting replays.
      tags:
        - Replay
      responses:
        "200":
          description: Available replay data per symbol
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbols:
                    type: array
                    items:
                      type: object
                      properties:
                        symbol_id:
                          type: string
                          description: Trading pair symbol
                        timeframe:
                          type: string
                          description: Candle timeframe (e.g., 1m)
                        earliest:
                          type: string
                          nullable: true
                          description: Earliest available data (ISO 8601)
                        latest:
                          type: string
                          nullable: true
                          description: Latest available data (ISO 8601)
                        candle_count:
                          type: integer
                          description: Total number of candles
                        duration_minutes:
                          type: integer
                          description: Duration in minutes
                      required:
                        - symbol_id
                        - timeframe
                        - earliest
                        - latest
                        - candle_count
                        - duration_minutes
                    description: Available replay data per symbol
                  generated_at:
                    type: string
                    description: When this data was generated (ISO 8601)
                required:
                  - symbols
                  - generated_at
  /api/annotations/{symbolId}:
    get:
      summary: Get ground truth annotations
      description: |
        Returns annotations for agent self-scoring.

        Annotation types:
        - `dump_event`: Significant price drops
        - `regime`: Market regime changes
        - `vol_spike`: Volatility spikes
      tags:
        - Annotations
      parameters:
        - schema:
            type: string
            enum:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
            example: COINBASE_SPOT_BTC_USD
            examples:
              - COINBASE_SPOT_BTC_USD
              - COINBASE_SPOT_ETH_USD
              - COINBASE_SPOT_SOL_USD
              - COINBASE_SPOT_AERO_USD
              - COINBASE_SPOT_RECALL_USD
          required: true
          name: symbolId
          in: path
        - schema:
            type: string
            description: Start time (ISO 8601)
            example: 2025-12-16T18:00:00Z
          required: false
          description: Start time (ISO 8601)
          name: from
          in: query
        - schema:
            type: string
            description: End time (ISO 8601)
            example: 2025-12-16T23:59:59Z
          required: false
          description: End time (ISO 8601)
          name: to
          in: query
        - schema:
            type: string
            enum:
              - dump_event
              - regime
              - vol_spike
              - sweep_reclaim
            description: Filter by annotation type
            example: dump_event
          required: false
          description: Filter by annotation type
          name: type
          in: query
        - schema:
            type: string
            enum:
              - dump-simple-1m-1pct
              - dump-simple-1m-3pct
              - dump-simple-1m-5pct
              - dump-simple-15m-1pct
              - dump-simple-15m-3pct
              - dump-simple-15m-5pct
              - dump-simple-1h-0.5pct
              - dump-simple-1h-1pct
              - dump-vol-adjusted-1m-z2
              - dump-vol-adjusted-15m-z2
              - dump-vol-adjusted-1h-z2
              - dump-drawdown-1pct
              - dump-drawdown-3pct
              - sweep-reclaim-low-5bar
              - sweep-reclaim-high-5bar
            description: Filter by specific annotator/detector
            example: dump-simple-1h-0.5pct
          required: false
          description: Filter by specific annotator/detector
          name: source
          in: query
        - schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
            description: Max annotations (1-1000)
            example: 100
          required: false
          description: Max annotations (1-1000)
          name: limit
          in: query
      responses:
        "200":
          description: Annotations (empty array if none exist)
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbol_id:
                    type: string
                    description: Trading pair symbol
                  annotations:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                          description: Unique annotation identifier
                        time_start:
                          type: string
                          description: Start time (ISO 8601)
                        time_end:
                          type: string
                          nullable: true
                          description: End time (ISO 8601), null for point-in-time events
                        type:
                          type: string
                          description: Annotation type (e.g., dump_event, regime, vol_spike)
                        schema_version:
                          type: string
                          description: Payload schema version
                        payload:
                          type: object
                          additionalProperties:
                            nullable: true
                          description: Type-specific annotation data
                        source:
                          type: string
                          description: Annotator that created this annotation
                        created_at:
                          type: string
                          description: Creation timestamp (ISO 8601)
                      required:
                        - id
                        - time_start
                        - time_end
                        - type
                        - schema_version
                        - payload
                        - source
                    description: List of annotations
                required:
                  - symbol_id
                  - annotations
        "400":
          description: Invalid parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
  /api/annotators:
    get:
      summary: List registered annotators
      description: >
        Returns all registered annotators with their status.

        Annotators automatically process historical and new data to create
        annotations.
      tags:
        - Annotators
      responses:
        "200":
          description: List of annotators
          content:
            application/json:
              schema:
                type: object
                properties:
                  annotators:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          description: Unique annotator identifier
                        version:
                          type: string
                          description: Annotator version
                        annotation_type:
                          type: string
                          description: Type of annotations produced
                        source:
                          type: string
                          description: Source identifier for created annotations
                        window_size:
                          type: string
                          description: Processing window size (e.g., 1m, 15m, 1h)
                        status:
                          type: string
                          enum:
                            - backfilling
                            - active
                            - deprecated
                          description: Current operational status
                        description:
                          type: string
                          description: Human-readable description
                      required:
                        - name
                        - version
                        - annotation_type
                        - source
                        - window_size
                        - status
                        - description
                    description: List of registered annotators
                required:
                  - annotators
  /api/annotators/{name}:
    get:
      summary: Get annotator details and progress
      description: |
        Returns details for a specific annotator including backfill progress.
      tags:
        - Annotators
      parameters:
        - schema:
            type: string
            description: Annotator name (e.g., dump-simple-15m-3pct)
            example: dump-simple-1m-1pct
          required: true
          description: Annotator name (e.g., dump-simple-15m-3pct)
          name: name
          in: path
      responses:
        "200":
          description: Annotator details
          content:
            application/json:
              schema:
                type: object
                properties:
                  annotator:
                    type: object
                    properties:
                      name:
                        type: string
                        description: Unique annotator identifier
                      version:
                        type: string
                        description: Annotator version
                      annotation_type:
                        type: string
                        description: Type of annotations produced
                      source:
                        type: string
                        description: Source identifier for created annotations
                      window_size:
                        type: string
                        description: Processing window size
                      start_time:
                        type: string
                        description: Start time for processing
                      status:
                        type: string
                        description: Current operational status
                      description:
                        type: string
                        description: Human-readable description
                      config:
                        type: object
                        additionalProperties:
                          nullable: true
                        description: Annotator configuration
                      registered_at:
                        type: string
                        description: Registration timestamp
                    required:
                      - name
                      - version
                      - annotation_type
                      - source
                      - window_size
                      - status
                      - description
                      - config
                    description: Annotator details
                  progress:
                    type: object
                    properties:
                      windows_processed:
                        type: integer
                        description: Total windows processed
                      annotations_created:
                        type: integer
                        description: Total annotations created
                      last_processed_at:
                        type: string
                        nullable: true
                        description: Last processing timestamp (ISO 8601)
                    required:
                      - windows_processed
                      - annotations_created
                      - last_processed_at
                    description: Processing progress
                required:
                  - annotator
                  - progress
        "404":
          description: Annotator not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
  /api/annotators/{name}/run:
    post:
      summary: Run annotator on time range
      description: >
        Manually trigger annotator processing for a specific symbol and time
        range.

        Useful for backfilling or reprocessing specific periods.
      tags:
        - Annotators
      parameters:
        - schema:
            type: string
            description: Annotator name
            example: dump-simple-1m-1pct
          required: true
          description: Annotator name
          name: name
          in: path
        - schema:
            type: string
            description: Symbol to process
            example: COINBASE_SPOT_BTC_USD
          required: true
          description: Symbol to process
          name: symbol_id
          in: query
        - schema:
            type: string
            description: Start time (ISO 8601)
            example: 2025-12-16T17:00:00Z
          required: true
          description: Start time (ISO 8601)
          name: from
          in: query
        - schema:
            type: string
            description: End time (ISO 8601)
            example: 2025-12-16T18:00:00Z
          required: true
          description: End time (ISO 8601)
          name: to
          in: query
      responses:
        "200":
          description: Annotator run result
          content:
            application/json:
              schema:
                type: object
                properties:
                  annotator:
                    type: string
                    description: Annotator name
                  symbol_id:
                    type: string
                    description: Symbol processed
                  from:
                    type: string
                    description: Start time (ISO 8601)
                  to:
                    type: string
                    description: End time (ISO 8601)
                  windows_processed:
                    type: integer
                    description: Number of windows processed
                  annotations_created:
                    type: integer
                    description: Number of annotations created
                required:
                  - annotator
                  - symbol_id
                  - from
                  - to
                  - windows_processed
                  - annotations_created
        "400":
          description: Invalid parameters
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
        "404":
          description: Annotator not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    description: Human-readable error message
                  code:
                    type: string
                    description: Machine-readable error code
                required:
                  - error
  /api/cron/ingest:
    get:
      summary: Trigger data ingestion
      description: >
        Called by cron every minute. Fetches OHLCV candles and order book
        snapshots for all symbols.


        Per cycle:

        - 5 OHLCV calls (last 5 candles per symbol)

        - 5 Orderbook calls (current snapshot per symbol)

        - Gap detection and healing (60-minute lookback)
      tags:
        - System
      responses:
        "200":
          description: Ingestion completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  batchId:
                    type: string
                    description: Unique batch identifier
                  ohlcvCount:
                    type: integer
                    description: Number of OHLCV candles ingested
                  orderbookCount:
                    type: integer
                    description: Number of orderbook snapshots ingested
                  symbols:
                    type: array
                    items:
                      type: string
                    description: Symbols processed in this ingestion run
                required:
                  - batchId
                  - ohlcvCount
                  - orderbookCount
                  - symbols
